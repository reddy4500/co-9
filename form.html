<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select System & Subsystem | CO-DOCTOR</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ... your existing CSS ... */
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-left">
            <img src="logo.jpeg" class="logo" alt="CO-DOCTOR Logo">
            <span class="brand-name">CO-DOCTOR</span>
        </div>
        <ul class="navbar-center">
            <li><a href="index.html">Home</a></li>
            <li><a href="#">About</a></li>
        </ul>
        <div class="navbar-right">
            <a href="#" onclick="logout()" class="login-btn">Logout</a>
        </div>
    </nav>

    <section class="main-section">
        <div class="form-container">
            <h2>Choose Your System</h2>
            <div class="greeting" id="greeting"></div>
            <div id="form-section">
                <select id="system-select">
                    <option value="">Select System</option>
                </select>
                <select id="subsystem-select" style="display:none;">
                    <option value="">Select Subsystem</option>
                </select>
                <button onclick="submitAssignment()" class="btn" id="submit-btn" style="display:none;">Submit</button>
            </div>
            <div id="assignment-info"></div>
            <div id="success-message"></div>
        </div>
    </section>
    <script>
    // -------- Supabase Config --------
    const SUPABASE_URL = "https://kxzkuphsoihlzjwbhghl.supabase.co";
    const SUPABASE_APIKEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4emt1cGhzb2lobHpqd2JoZ2hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NjcyNTIsImV4cCI6MjA2MTM0MzI1Mn0.6Fa0GLY82aMO19boMFeAfWypeuMflxi90jpOq12s0K8";

    // -------- System Data --------
    const systems = [
        {id: 1, name: "Respiratory Medicine (Pulmo)", subsystems: ["RICU", "TB and exam ward", "OP", "Casualty"]},
        {id: 2, name: "Pediatrics", subsystems: ["Wards", "PICU", "OP"]},
        {id: 3, name: "General Surgery", subsystems: ["OP", "Wards"]},
        {id: 4, name: "Radiology", subsystems: ["Morning", "Afternoon", "Night"]},
        {id: 5, name: "ENT", subsystems: ["Casualty", "Ward"]},
        {id: 6, name: "Orthopedics", subsystems: ["OP", "Ward/Casualty", "OT", "Casualty"]},
        {id: 7, name: "SPM (Community Medicine)", subsystems: ["Gudihattham", "Khurikidivagas", "Psychiatry", "CS", "DTC", "SUC", "Department"]},
        {id: 8, name: "Casualty", subsystems: [
            "CMO (8am-2pm, 2pm-8pm, 8pm-12am, 8pm-8am)",
            "COTM (medical/surgical)",
            "DSO (surgery)",
            "Pulmo (casualty/other)",
            "ENT",
            "Ophthal",
            "Psy"
        ]},
        {id: 9, name: "Medicine", subsystems: ["MICU", "COTM", "BCCO", "MMW", "FMW", "OP"]},
        {id: 10, name: "OBG & Labour Room", subsystems: [
            "Labour Room (Morning/Night)",
            "Admissions",
            "HDU",
            "Labour Room Intern",
            "POW 1",
            "POW 2",
            "PHW",
            "OP"
        ]},
        {id: 11, name: "Anaesthesia", subsystems: [
            "SS H",
            "Old Building",
            "Full Duty"
        ]}
    ];

    // -------- Utility --------
    function getUsername() {
        return localStorage.getItem('username');
    }
    function checkLogin() {
        if (!localStorage.getItem('loggedIn') || !getUsername()) {
            window.location.href = 'login.html';
        }
    }
    checkLogin();

    // -------- Greet User --------
    async function greetUser() {
        const username = getUsername();
        if (!username) return;
        const users = await fetch(`${SUPABASE_URL}/rest/v1/users?username=eq.${encodeURIComponent(username)}&select=*`, {
            headers: { apikey: SUPABASE_APIKEY, Authorization: `Bearer ${SUPABASE_APIKEY}` }
        }).then(res => res.json());
        const user = users[0];
        if (user && document.getElementById('greeting')) {
            document.getElementById('greeting').innerHTML =
                `Welcome, <b>${user.fullname}</b><br>Phone: <b>${user.phone}</b>`;
        }
    }

    // -------- Populate Systems --------
    function populateSystems() {
        const systemSelect = document.getElementById('system-select');
        systems.forEach(system => {
            const opt = document.createElement('option');
            opt.value = system.id;
            opt.textContent = system.name;
            systemSelect.appendChild(opt);
        });
    }

    document.getElementById('system-select').addEventListener('change', function() {
        const systemId = this.value;
        const subsystemSelect = document.getElementById('subsystem-select');
        subsystemSelect.innerHTML = '<option value="">Select Subsystem</option>';
        if (systemId) {
            const system = systems.find(s => s.id == systemId);
            system.subsystems.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                subsystemSelect.appendChild(opt);
            });
            subsystemSelect.style.display = '';
            document.getElementById('submit-btn').style.display = '';
        } else {
            subsystemSelect.style.display = 'none';
            document.getElementById('submit-btn').style.display = 'none';
        }
    });

    // -------- Assignment Logic (Supabase) --------
    async function showAssignmentInfo() {
        const username = getUsername();
        const assignments = await fetch(`${SUPABASE_URL}/rest/v1/assignments?username=eq.${encodeURIComponent(username)}&select=*`, {
            headers: { apikey: SUPABASE_APIKEY, Authorization: `Bearer ${SUPABASE_APIKEY}` }
        }).then(res => res.json());

        let assigned = false, assignedSystem = '', assignedSubsystem = '', assignedSystemId = '';
        if (assignments.length) {
            assigned = true;
            assignedSystemId = assignments[0].system_id;
            assignedSystem = systems.find(s => s.id == assignedSystemId)?.name || assignedSystemId;
            assignedSubsystem = assignments[0].subsystem;
        }
        const assignmentDiv = document.getElementById('assignment-info');
        if (assigned) {
            document.getElementById('form-section').style.display = 'none';
            assignmentDiv.innerHTML = `
                <b>You are assigned to:</b><br>
                System: <b>${assignedSystem}</b><br>
                Subsystem: <b>${assignedSubsystem}</b><br>
                <button id="leave-btn">Leave</button>
            `;
            document.getElementById('leave-btn').onclick = function() {
                leaveAssignment(assignedSystemId, assignedSubsystem, username);
            };
        } else {
            document.getElementById('form-section').style.display = '';
            assignmentDiv.innerHTML = '';
        }
    }

    async function submitAssignment() {
        const systemId = document.getElementById('system-select').value;
        const subsystem = document.getElementById('subsystem-select').value;
        const msg = document.getElementById('success-message');
        msg.textContent = "";

        if (!systemId || !subsystem) {
            msg.style.color = "#c0392b";
            msg.textContent = "Please select both system and subsystem.";
            return;
        }

        const username = getUsername();
        // Get user info
        const users = await fetch(`${SUPABASE_URL}/rest/v1/users?username=eq.${encodeURIComponent(username)}&select=*`, {
            headers: { apikey: SUPABASE_APIKEY, Authorization: `Bearer ${SUPABASE_APIKEY}` }
        }).then(res => res.json());
        const user = users[0];

        // Remove previous assignments for this user
        await fetch(`${SUPABASE_URL}/rest/v1/assignments?username=eq.${encodeURIComponent(username)}`, {
            method: "DELETE",
            headers: {
                apikey: SUPABASE_APIKEY,
                Authorization: `Bearer ${SUPABASE_APIKEY}`
            }
        });

        // Add new assignment
        const response = await fetch(`${SUPABASE_URL}/rest/v1/assignments`, {
            method: "POST",
            headers: {
                apikey: SUPABASE_APIKEY,
                Authorization: `Bearer ${SUPABASE_APIKEY}`,
                "Content-Type": "application/json",
                Prefer: "return=representation"
            },
            body: JSON.stringify({
                username,
                system_id: systemId,
                subsystem,
                fullname: user.fullname,
                phone: user.phone
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            msg.style.color = "#c0392b";
            msg.textContent = "Assignment failed: " + errorText;
            return;
        }

        msg.style.color = "#27ae60";
        msg.textContent = "Assignment successful!";
        setTimeout(() => {
            msg.textContent = "";
            showAssignmentInfo();
        }, 800);
    }

    async function leaveAssignment(systemId, subsystem, username) {
        await fetch(`${SUPABASE_URL}/rest/v1/assignments?username=eq.${encodeURIComponent(username)}&system_id=eq.${systemId}&subsystem=eq.${encodeURIComponent(subsystem)}`, {
            method: "DELETE",
            headers: {
                apikey: SUPABASE_APIKEY,
                Authorization: `Bearer ${SUPABASE_APIKEY}`
            }
        });
        const msg = document.getElementById('success-message');
        msg.style.color = "#c0392b";
        msg.textContent = "You have left the subsystem.";
        setTimeout(() => {
            msg.textContent = "";
            showAssignmentInfo();
        }, 1000);
    }

    function logout() {
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('username');
        window.location.href = 'login.html';
    }

    // -------- On page load --------
    greetUser();
    populateSystems();
    showAssignmentInfo();
    </script>
</body>
</html>
