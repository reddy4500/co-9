<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doctors Availability | CO-DOCTOR</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f8fa;
            margin: 0;
        }
        .navbar {
            background: #003366;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 60px;
            justify-content: space-between;
        }
        .navbar-left {
            display: flex;
            align-items: center;
        }
        .logo {
            height: 38px;
            margin-right: 12px;
        }
        .brand-name {
            font-weight: bold;
            font-size: 1.3em;
        }
        .navbar-center {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 20px;
        }
        .navbar-center li a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
        }
        .navbar-center li a.active, .navbar-center li a:hover {
            background: #0056b3;
        }
        .navbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .navbar-right .login-btn, .navbar-right .logout-btn {
            color: #fff;
            text-decoration: none;
            background: #0056b3;
            padding: 8px 18px;
            border-radius: 6px;
            font-weight: bold;
            transition: background 0.2s;
            border: none;
            cursor: pointer;
        }
        .navbar-right .login-btn:hover, .navbar-right .logout-btn:hover {
            background: #0074d9;
        }
        #doctor-credentials {
            font-size: 1em;
            color: #bde0ff;
            margin-right: 10px;
        }
        .main-section {
            max-width: 1100px;
            margin: 40px auto 0 auto;
            padding: 0 16px;
        }
        .main-section h1 {
            color: #003366;
            margin-bottom: 24px;
            text-align: center;
        }
        .system-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin-top: 40px;
        }
        .system-box {
            background: #0188df;
            color: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            width: 320px;
            min-height: 70px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            padding: 24px 28px 18px 28px;
            font-size: 1.18em;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
        }
        .system-box:hover {
            background: #0056b3;
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }
        .subsystem-list {
            margin: 12px 0 0 10px;
            padding-left: 14px;
            font-size: 0.98em;
            color: #e0f7fa;
        }
        .subsystem-list li {
            margin-bottom: 2px;
        }
        @media (max-width: 700px) {
            .system-box {
                width: 95vw;
                min-width: unset;
                font-size: 1em;
                padding: 18px 8px 14px 8px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-left">
            <img src="logo.jpeg" class="logo" alt="CO-DOCTOR Logo">
            <span class="brand-name">CO-DOCTOR</span>
        </div>
        <ul class="navbar-center">
            <li><a href="index.html" class="active">Home</a></li>
            <li><a href="#">About</a></li>
        </ul>
        <div class="navbar-right">
            <span id="doctor-credentials"></span>
            <a href="login.html" class="login-btn" id="login-btn" style="display:none;">Login</a>
            <button class="logout-btn" id="logout-btn" style="display:none;" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- Main Section -->
    <section class="main-section">
        <h1>Hospital Systems</h1>
        <div class="system-grid" id="system-grid"></div>
    </section>

    <script>
        // --- Supabase Initialization ---
        const SUPABASE_URL = "https://kxzkuphsoihlzjwbhghl.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4emt1cGhzb2lobHpqd2JoZ2hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NjcyNTIsImV4cCI6MjA2MTM0MzI1Mn0.6Fa0GLY82aMO19boMFeAfWypeuMflxi90jpOq12s0K8";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- RENDER SYSTEMS AND SUBSYSTEMS FROM SUPABASE ---
        async function renderSystems() {
            const grid = document.getElementById('system-grid');
            grid.innerHTML = '<div style="color:#888;">Loading systems...</div>';

            // Try to fetch systems and their subsystems from Supabase
            let { data: systems, error } = await supabase
                .from('systems')
                .select('id, name, subsystems ( id, name )')
                .order('id', { ascending: true });

            // If error or no table, fallback to static
            if (error || !systems || systems.length === 0) {
                systems = [
                    {id: 1, name: "Respiratory Medicine (Pulmo)", subsystems: [{name:"RICU"}, {name:"TB and exam ward"}, {name:"OP"}, {name:"Casualty"}]},
                    {id: 2, name: "Pediatrics", subsystems: [{name:"Wards"}, {name:"PICU"}, {name:"OP"}]},
                    {id: 3, name: "General Surgery", subsystems: [{name:"OP"}, {name:"Wards"}]},
                    {id: 4, name: "Radiology", subsystems: [{name:"Morning"}, {name:"Afternoon"}, {name:"Night"}]},
                    {id: 5, name: "ENT", subsystems: [{name:"Casualty"}, {name:"Ward"}]},
                    {id: 6, name: "Orthopedics", subsystems: [{name:"OP"}, {name:"Ward/Casualty"}, {name:"OT"}, {name:"Casualty"}]},
                    {id: 7, name: "SPM (Community Medicine)", subsystems: [{name:"Gudihattham"}, {name:"Khurikidivagas"}, {name:"Psychiatry"}, {name:"CS"}, {name:"DTC"}, {name:"SUC"}, {name:"Department"}]},
                    {id: 8, name: "Casualty", subsystems: [
                        {name:"CMO (8am-2pm, 2pm-8pm, 8pm-12am, 8pm-8am)"},
                        {name:"COTM (medical/surgical)"},
                        {name:"DSO (surgery)"},
                        {name:"Pulmo (casualty/other)"},
                        {name:"ENT"},
                        {name:"Ophthal"},
                        {name:"Psy"}
                    ]},
                    {id: 9, name: "Medicine", subsystems: [{name:"MICU"}, {name:"COTM"}, {name:"BCCO"}, {name:"MMW"}, {name:"FMW"}, {name:"OP"}]},
                    {id: 10, name: "OBG & Labour Room", subsystems: [
                        {name:"Labour Room (Morning/Night)"},
                        {name:"Admissions"},
                        {name:"HDU"},
                        {name:"Labour Room Intern"},
                        {name:"POW 1"},
                        {name:"POW 2"},
                        {name:"PHW"},
                        {name:"OP"}
                    ]},
                    {id: 11, name: "Anaesthesia", subsystems: [
                        {name:"SS H"},
                        {name:"Old Building"},
                        {name:"Full Duty"}
                    ]}
                ];
            }

            grid.innerHTML = '';
            systems.forEach(system => {
                const box = document.createElement('div');
                box.className = 'system-box';
                box.innerHTML = `<b>${system.id}. ${system.name}</b>`;
                if (system.subsystems && system.subsystems.length) {
                    box.innerHTML += `<ul class="subsystem-list">` +
                        system.subsystems.map(sub => `<li>${sub.name}</li>`).join('') +
                        `</ul>`;
                }
                box.onclick = () => {
                    window.location.href = `system.html?system=${system.id}`;
                };
                grid.appendChild(box);
            });
        }

        // --- SHOW DOCTOR CREDENTIALS & BUTTONS FROM SUPABASE ---
        async function showDoctorCredentials() {
            const loggedIn = localStorage.getItem('loggedIn');
            const username = localStorage.getItem('username');
            const credElem = document.getElementById('doctor-credentials');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (loggedIn && username) {
                // Fetch user from Supabase
                const { data: users } = await supabase
                    .from('users')
                    .select('fullname,phone')
                    .eq('username', username)
                    .limit(1);
                if (users && users.length > 0) {
                    credElem.innerHTML = `Dr. <b>${users[0].fullname}</b> | <span style="color:#fff;">${users[0].phone}</span>`;
                    loginBtn.style.display = 'none';
                    logoutBtn.style.display = '';
                } else {
                    credElem.innerHTML = '';
                    loginBtn.style.display = '';
                    logoutBtn.style.display = 'none';
                }
            } else {
                credElem.innerHTML = '';
                loginBtn.style.display = '';
                logoutBtn.style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        // --- INIT ---
        renderSystems();
        showDoctorCredentials();
    </script>
</body>
</html>
