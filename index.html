<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doctor Dashboard | CO-DOCTOR</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard { max-width: 400px; margin: 40px auto; background: #f7faff; padding: 32px; border-radius: 14px; box-shadow: 0 2px 18px #0001; }
        .dashboard h2 { text-align: center; color: #003366; }
        .assignment-info { margin: 24px 0; font-size: 1.1em; text-align: center; }
        .dashboard .btn { width: 100%; margin: 8px 0; padding: 12px; font-size: 1.1em; border-radius: 6px; border: none; cursor: pointer; }
        .btn-primary { background: #27ae60; color: #fff; }
        .btn-danger { background: #c0392b; color: #fff; }
        .btn-secondary { background: #ddd; color: #222; }
        #assignment-form { margin-top: 24px; }
        #feedback-message { text-align: center; margin-top: 18px; font-weight: bold; }
        @media (max-width: 500px) { .dashboard { padding: 12px; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <img src="logo.jpg" class="logo" alt="CO-DOCTOR Logo">
            <span class="brand-name">CO-DOCTOR</span>
        </div>
        <ul class="navbar-center">
            <li><a href="index.html">Home</a></li>
            <li><a href="dashboard.html" class="active">Dashboard</a></li>
        </ul>
        <div class="navbar-right">
            <span id="doctor-credentials"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="dashboard">
        <h2 id="greeting"></h2>
        <div id="assignment-info" class="assignment-info"></div>
        <div id="assignment-form" style="display:none;">
            <select id="system-select"></select>
            <select id="subsystem-select"></select>
            <button class="btn btn-primary" onclick="submitAssignment()">Assign Me</button>
            <button class="btn btn-secondary" onclick="hideAssignmentForm()">Cancel</button>
        </div>
        <div id="feedback-message"></div>
    </div>

    <script src="script.js"></script>
    <script>
    // --- SYSTEMS DATA ---
    const systems = [
        {id: 1, name: "Respiratory Medicine (Pulmo)", subsystems: ["RICU", "TB and exam ward", "OP", "Casualty"]},
        {id: 2, name: "Pediatrics", subsystems: ["Wards", "PICU", "OP"]},
        {id: 3, name: "General Surgery", subsystems: ["OP", "Wards"]},
        {id: 4, name: "Radiology", subsystems: ["Morning", "Afternoon", "Night"]},
        {id: 5, name: "ENT", subsystems: ["Casualty", "Ward"]},
        {id: 6, name: "Orthopedics", subsystems: ["OP", "Ward/Casualty", "OT", "Casualty"]},
        {id: 7, name: "SPM (Community Medicine)", subsystems: ["Gudihattham", "Khurikidivagas", "Psychiatry", "CS", "DTC", "SUC", "Department"]},
        {id: 8, name: "Casualty", subsystems: [
            "CMO (8am-2pm, 2pm-8pm, 8pm-12am, 8pm-8am)",
            "COTM (medical/surgical)",
            "DSO (surgery)",
            "Pulmo (casualty/other)",
            "ENT",
            "Ophthal",
            "Psy"
        ]},
        {id: 9, name: "Medicine", subsystems: ["MICU", "COTM", "BCCO", "MMW", "FMW", "OP"]},
        {id: 10, name: "OBG & Labour Room", subsystems: [
            "Labour Room (Morning/Night)",
            "Admissions",
            "HDU",
            "Labour Room Intern",
            "POW 1",
            "POW 2",
            "PHW",
            "OP"
        ]},
        {id: 11, name: "Anaesthesia", subsystems: [
            "SS H",
            "Old Building",
            "Full Duty"
        ]}
    ];

    // --- DASHBOARD LOGIC ---
    function showDashboard() {
        // Auth check
        const loggedIn = localStorage.getItem('loggedIn');
        const username = localStorage.getItem('username');
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        const user = users[username];
        if (!loggedIn || !user) { window.location.href = 'login.html'; return; }

        document.getElementById('greeting').innerHTML = `Welcome, <b>Dr. ${user.fullname}</b>`;
        document.getElementById('doctor-credentials').innerHTML = `Dr. ${user.fullname} | ${user.phone}`;

        // Assignment check
        const assignments = JSON.parse(localStorage.getItem('assignments') || '{}');
        let assigned = false, sysId, subsystem, sysName;
        for (const sId in assignments) {
            for (const sub in assignments[sId]) {
                if (assignments[sId][sub].some(u => u.username === username)) {
                    assigned = true;
                    sysId = sId;
                    subsystem = sub;
                    sysName = systems.find(s => s.id == sId).name;
                    break;
                }
            }
            if (assigned) break;
        }
        const infoDiv = document.getElementById('assignment-info');
        const formDiv = document.getElementById('assignment-form');
        const feedback = document.getElementById('feedback-message');
        feedback.innerText = '';

        if (assigned) {
            infoDiv.innerHTML = `
                <p>You are assigned to:<br><b>${sysName}</b> - <b>${subsystem}</b></p>
                <button class="btn btn-primary" onclick="showAssignmentForm(true)">Change Assignment</button>
                <button class="btn btn-danger" onclick="leaveAssignment()">Leave Assignment</button>
            `;
            formDiv.style.display = 'none';
        } else {
            infoDiv.innerHTML = `
                <p>You are not assigned to any system.</p>
                <button class="btn btn-primary" onclick="showAssignmentForm()">Assign Myself</button>
            `;
            formDiv.style.display = 'none';
        }
    }

    function showAssignmentForm(isChange) {
        // Populate dropdowns
        const systemSelect = document.getElementById('system-select');
        const subsystemSelect = document.getElementById('subsystem-select');
        systemSelect.innerHTML = '<option value="">Select System</option>';
        systems.forEach(sys => {
            const opt = document.createElement('option');
            opt.value = sys.id;
            opt.textContent = sys.name;
            systemSelect.appendChild(opt);
        });
        subsystemSelect.innerHTML = '<option value="">Select Subsystem</option>';
        systemSelect.onchange = function() {
            const sys = systems.find(s => s.id == this.value);
            subsystemSelect.innerHTML = '<option value="">Select Subsystem</option>';
            if (sys) {
                sys.subsystems.forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub;
                    opt.textContent = sub;
                    subsystemSelect.appendChild(opt);
                });
            }
        };
        document.getElementById('assignment-form').style.display = '';
        document.getElementById('assignment-info').style.display = 'none';
        document.getElementById('feedback-message').innerText = isChange ? 'Select new system/subsystem to change assignment.' : '';
    }

    function hideAssignmentForm() {
        document.getElementById('assignment-form').style.display = 'none';
        document.getElementById('assignment-info').style.display = '';
        document.getElementById('feedback-message').innerText = '';
    }

    function submitAssignment() {
        const systemId = document.getElementById('system-select').value;
        const subsystem = document.getElementById('subsystem-select').value;
        const feedback = document.getElementById('feedback-message');
        if (!systemId || !subsystem) {
            feedback.style.color = "#c0392b";
            feedback.innerText = "Please select both system and subsystem!";
            return;
        }
        const username = localStorage.getItem('username');
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        const user = users[username];
        let assignments = JSON.parse(localStorage.getItem('assignments') || '{}');
        // Remove from previous assignment
        for (const sId in assignments) {
            for (const sub in assignments[sId]) {
                assignments[sId][sub] = assignments[sId][sub].filter(u => u.username !== username);
            }
        }
        if (!assignments[systemId]) assignments[systemId] = {};
        if (!assignments[systemId][subsystem]) assignments[systemId][subsystem] = [];
        assignments[systemId][subsystem].push({
            fullname: user.fullname,
            phone: user.phone,
            username: username
        });
        localStorage.setItem('assignments', JSON.stringify(assignments));
        feedback.style.color = "#27ae60";
        feedback.innerText = "Assignment successful!";
        setTimeout(() => { showDashboard(); }, 1000);
    }

    function leaveAssignment() {
        const username = localStorage.getItem('username');
        let assignments = JSON.parse(localStorage.getItem('assignments') || '{}');
        for (const sId in assignments) {
            for (const sub in assignments[sId]) {
                assignments[sId][sub] = assignments[sId][sub].filter(u => u.username !== username);
            }
        }
        localStorage.setItem('assignments', JSON.stringify(assignments));
        document.getElementById('feedback-message').style.color = "#c0392b";
        document.getElementById('feedback-message').innerText = "You have left your assignment.";
        setTimeout(() => { showDashboard(); }, 1000);
    }

    // On load
    document.addEventListener('DOMContentLoaded', showDashboard);
    </script>
    <script>
// Dynamically add "Assignment" button to the navbar
document.addEventListener('DOMContentLoaded', function() {
  const navbarCenter = document.querySelector('.navbar-center');
  if (navbarCenter) {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = 'dashboard.html'; // or 'form.html' if that's your assignment page
    a.textContent = 'Assignment';
    a.classList.add('btn'); // optional: use your button styling
    li.appendChild(a);
    navbarCenter.appendChild(li);
  }
});
</script>

</body>
</html>
