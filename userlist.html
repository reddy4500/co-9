<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Subsystem Users | CO-DOCTOR</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ... keep existing styles ... */
    </style>
    <!-- Add Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
    <!-- Navbar (keep existing structure) -->
    
    <section class="main-section">
        <div id="subsystem-title" class="subsystem-title"></div>
        <div class="user-list" id="user-list"></div>
        <div id="no-users" class="no-users"></div>
    </section>

    <script>
        // --- Supabase Initialization ---
        const SUPABASE_URL = "https://kxzkuphsoihlzjwbhghl.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4emt1cGhzb2lobHpqd2JoZ2hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NjcyNTIsImV4cCI6MjA2MTM0MzI1Mn0.6Fa0GLY82aMO19boMFeAfWypeuMflxi90jpOq12s0K8";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function getAssignedUsers(systemId, subsystem) {
            // First get user IDs from assignments
            const { data: assignments, error: assignError } = await supabase
                .from('assignments')
                .select('user_id')
                .eq('system_id', systemId)
                .eq('subsystem', subsystem);

            if (assignError || !assignments || assignments.length === 0) {
                return [];
            }

            // Get user details from users table
            const userIds = assignments.map(a => a.user_id);
            const { data: users, error: userError } = await supabase
                .from('users')
                .select('fullname, phone')
                .in('id', userIds);

            return users || [];
        }

        async function renderUsers() {
            const params = new URLSearchParams(window.location.search);
            const systemId = parseInt(params.get('system'), 10);
            const subsystem = params.get('subsystem');
            
            document.getElementById('subsystem-title').textContent = 
                `Subsystem: ${subsystem}`;

            const userList = document.getElementById('user-list');
            const noUsers = document.getElementById('no-users');
            
            userList.innerHTML = '<div style="color:#888;">Loading users...</div>';
            noUsers.textContent = '';

            try {
                const users = await getAssignedUsers(systemId, subsystem);

                userList.innerHTML = '';
                if (users.length === 0) {
                    noUsers.textContent = 'No users assigned to this subsystem yet.';
                    return;
                }

                users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'user-card';
                    div.innerHTML = `
                        <div class="user-name">${user.fullname}</div>
                        <div class="user-phone">${user.phone}</div>
                    `;
                    userList.appendChild(div);
                });
            } catch (error) {
                userList.innerHTML = '';
                noUsers.textContent = 'Error loading users. Please try again.';
                console.error('Supabase error:', error);
            }
        }

        // Initial render
        renderUsers();
    </script>
</body>
</html>
